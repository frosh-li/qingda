define(["require","api","common","blocks/stationSelector"],function(e,t,n,r){var i=null,s={extobj:{data:null,listPlugin:[],el:"#batteryEditTpl-dialog",events:{"click .submit-btn":"onsubmit","click .next-btn":"onnext","click .cancel-btn":"oncancel"},initialize:function(e){var t=this;t.listenTo(Backbone.Events,"batteryInfo:get",function(e){t.data=e,t.setValue()}),t.listenTo(Backbone.Events,"battery:create batteryInfo:update",function(){t.oncancel(),window.location.reload(),Backbone.Events.trigger("listdata:refresh","batteryInfo")}),t.listenTo(Backbone.Events,"battery:create:next",function(e){var e=t.getParam();delete e.id,console.log("battery next",e),t.oncancel(),Backbone.Events.trigger("battery:next",e)})},setValue:function(e){var e=e||this.data;e&&(n.setFormValue(this.el,e),$("[key=sid]",this.el).val(e.serial_number||e.sid.substring(0,10)),console.log("now data",e))},getParam:function(){var e=n.getFormValue(this.el,!0);return e.serial_number=$("[key=sid]").val(),e},showErrTips:function(e){return alert(e),!1},validate:function(e){if(!e.site_name)return this.showErrTips("站点为必填项");if(!e.sid)return this.showErrTips("站点不存在");var t=!0,n=$(".mast-fill",this.el);return n.each(function(n,r){var i=$(r).attr("for"),s;if(i&&(typeof e[i]=="undefined"||!e[i]))return s=$(r).parent().html().replace(/<i[^>]*>.*(?=<\/i>)<\/i>/gi,""),alert(s+"为必填项"),t=!1,!1}),t?!0:!1},onsubmit:function(){var e=this,n=e.getParam();e.validate(n)&&(n.id?t.updateBatteryInfo(n):t.createBattery(n))},onnext:function(){var e=this,n=e.getParam();e.validate(n)&&t.createBattery(n,"battery:create:next")},oncancel:function(){this.stopListening(),this.dialogObj.dialog("destroy"),$(".ui-dialog,.ui-widget-overlay").remove(),o.autocomplete("destroy")}}},o;return{show:function(e,n){var u=$("#batteryEditTpl-dialog").length?$("#batteryEditTpl-dialog").replaceWith($($("#batteryEditTpl").html())):$($("#batteryEditTpl").html()),a=JSON.parse(localStorage.getItem("userinfo")).role,f="";a!=1?f="disabled":f="",u.dialog({modal:!0,show:300,height:560,width:1e3,title:"电池信息",close:function(e,t){i.oncancel()},open:function(){!e&&n&&$("[key=site_name]").attr("disabled","disabled"),$("form.jqtransform").jqTransform(),i=new(Backbone.View.extend(s.extobj)),i.dialogObj=$(this),$("form.jqtransform").html($("form.jqtransform").html().replace(/{{disabled}}/g,f)),$("form.jqtransform").find("[changedisabled=disabled]").attr("disabled",!0),e?($(".submit-btn",i.el).show(),t.getBatteryInfo({id:e})):$(".next-btn",i.el).show(),n&&(console.log("battery init",n),n.sid=n.sid.substring(0,10),i.setValue(n)),o=r.init({extOption:{select:function(e,t){return console.log("setup list"),$(this).val(t.item.label),$("[key=sid]").val(t.item.value.substring(0,10)),!1}}}),$("form.jqtransform [ipttype=date]").datepicker({dateFormat:"yy-mm-dd"})}})},detroy:function(){i.oncancel()}}});