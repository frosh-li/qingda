define(["require","api","common","blocks/levelSlector"],function(e,t,n,r){var i=null,s={extobj:{data:null,listPlugin:[],el:"#stationEditTpl-dialog",events:{"click .submit-btn":"onsubmit","click .next-btn":"onnext","click .cancel-btn":"oncancel"},initialize:function(e){var t=this;t.listenTo(Backbone.Events,"stationinfo:foredit:update",function(e){t.data=e,t.data.serial_number=t.data.serial_number.substring(0,10),o=o||r.init({value:e.aid}),t.setValue()}),t.listenTo(Backbone.Events,"stationdata:create stationdata:update",function(e){n.loadTips.close(),t.oncancel(),window.location.reload(),Backbone.Events.trigger("listdata:refresh","station")}),t.listenTo(Backbone.Events,"stationdata:create:fail stationdata:update:fail",function(e){console.log("fail data",e),n.loadTips.close(),alert(e.response.msg)}),t.listenTo(Backbone.Events,"station:create:next",function(e){n.loadTips.close(),t.oncancel(),Backbone.Events.trigger("listdata:refresh","station"),e.serial_number=$("[key=serial_number]",this.el).val(),Backbone.Events.trigger("station:next",e)}),t.listenTo(Backbone.Events,"station:create:next:fail",function(e){n.loadTips.close(),alert(e.response.msg)})},setValue:function(){this.data&&n.setFormValue(this.el,this.data)},getParam:function(){var e=n.getFormValue(this.el,!0);return e.serial_number=$("[key=serial_number]",this.el).val()+"0000",console.log("getParam",e),e},showErrTips:function(e){return alert(e),!1},validate:function(e){if(!e.area)return this.showErrTips("隶属区域为必填项");if(!e.sid)return this.showErrTips("站号为必填项");var t=!0,n=$(".mast-fill",this.el);return n.each(function(n,r){var i=$(r).attr("for"),s;if(i&&(typeof e[i]=="undefined"||!e[i]))return s=$(r).parent().html().replace(/<i[^>]*>.*(?=<\/i>)<\/i>/gi,""),alert(s+"为必填项"),t=!1,!1}),t?/^\d{14}$/.test(e.serial_number)?!0:this.showErrTips("物理地址必须为10位数字"):!1},onsubmit:function(){var e=this,r=e.getParam();r.area=o.getValue(),e.validate(r)&&(n.loadTips.show("正在保存，请稍后..."),r.id?(t.syncHard({sn_key:r.serial_number,CurSensor:r.CurSensor||101,sid:r.sid,Groups:r.groups,GroBats:r.batteries},"StationPar"),t.updateStation(r)):(t.syncHard({sn_key:r.serial_number,CurSensor:r.CurSensor||101,sid:r.sid,Groups:r.groups,GroBats:r.batteries},"StationPar"),t.createStation(r)))},onnext:function(){var e=this,n=e.getParam();n.area=o.getValue(),e.validate(n)&&t.createStation(n,"station:create:next")},oncancel:function(){this.stopListening(),o.destroy(),o=null,this.dialogObj.dialog("destroy"),$(".ui-dialog,.ui-widget-overlay").remove()}}},o;return{show:function(e,n){var u=$("#stationEditTpl-dialog").length?$("#stationEditTpl-dialog").replaceWith($($("#stationEditTpl").html())):$($("#stationEditTpl").html()),a=JSON.parse(localStorage.getItem("userinfo")).role,f="";a!=1?f="disabled":f="",u.dialog({modal:!0,show:300,height:820,width:1e3,title:e?"编辑站点":"添加站点",close:function(e,t){i.oncancel()},open:function(){i=new(Backbone.View.extend(s.extobj)),i.dialogObj=$(this),$("form.jqtransform").html($("form.jqtransform").html().replace(/{{disabled}}/g,f)),$("form.jqtransform").find("[changedisabled=disabled]").attr("disabled",!0),e?($(".submit-btn",i.el).show(),t.getStationEditInfo({id:e})):($(".next-btn",i.el).show(),o=r.init()),n&&(console.log("bringdata",n),$("[key=serial_number]").val(n.sn_key.substring(0,10)),$("[key=sid]").val(n.sid),$("[key=groups]").val(n.Groups),$("[key=batteries]").val(n.GroBats),$("[key=CurSensor]").val(n.CurSensor)),$("form.jqtransform [key=bms_install_date]").datepicker({dateFormat:"yy-mm-dd"}),$("form.jqtransform").jqTransform()}})},detroy:function(){i.oncancel()}}});