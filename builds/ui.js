define(["require","backbone","api","context","common"],function(e){function u(){$("body").removeClass("small"),$(window).width()<1640&&$("body").addClass("small")}var t=e("backbone"),n=e("api"),r=e("context"),i=e("common"),s=!1,o=t.View.extend({el:"body",events:{"click #addStation":"onAddStation","click #addBattery":"onAddBattery","click #addDevice":"onAddDevice","click #addUps":"onAddUPS","click #addBMS":"onAddBMS","click #addCompany":"onAddCompany","click #addMessage":"onAddMessage","click #addPersonal":"onAddPersonal","click #addStationOption":"onAddStationOption","click #singleChart":"showSingleChart","click #mutipleChart":"showMutipleChart","click #saveOtherOptionBtn":"saveOtherOption","click .left-hide":"leftHide","click .yx-show":"leftShow","click .zoom":"upShow","click .bottom-hide":"downHide","click .bottom-show":"downShow","click .switch-btn a":"switchBtn","click .ggsj":"onUpadtaTime","click #startCollectBtn":"startCollect","click #navSearchBtn":"onSearchNav","click .tzcj":"stopCollect","click .title-list .switch-btn i":"showItemsLayer","click .cj-btn":"onSearch","click .exportdata":"onExportCSV","click #searchBtn span span":"onSearch","click #switchUser":"switchUser","click #startCollectR":"startCollectR","click #about":"about"},initialize:function(){var n=this;n.listenTo(t.Events,"refreshtime:update",function(e){alert("设置成功"),n.isCollecting()&&n.stopCollect().startCollect()}),n.listenTo(t.Events,"refresh:get",function(e){$("#collectDuration").val(e.refresh)}),n.listenTo(t.Events,"linknum:get",function(e){$("#linkingNum").html(e.online),$("#unlinkNum").html(e.offline),$("#collectDuration").val(e.refresh),e.dismap==0?$("#map-switch").hide():$("#map-switch").show(),e.voice_on_off=="1"?$("#alarm_sound").removeClass("graylight").addClass("grelight"):$("#alarm_sound").removeClass("grelight").addClass("graylight"),e.light_on_off=="1"?$("#alarm_light").removeClass("graylight").addClass("grelight"):$("#alarm_light").removeClass("grelight").addClass("graylight"),e.upiao=="1"?$("#alarm_collecting").removeClass("graylight").addClass("grelight"):$("#alarm_collecting").removeClass("grelight").addClass("graylight"),e.sms_on_off=="1"?$("#alarm_sms").removeClass("graylight").addClass("grelight"):$("#alarm_sms").removeClass("grelight").addClass("graylight"),e.email_on_off=="1"?$("#alarm_mail").removeClass("graylight").addClass("grelight"):$("#alarm_mail").removeClass("grelight").addClass("graylight")}),n.listenTo(t.Events,"otherOption:get",function(t){e(["common"],function(e){e.setFormValue($("#otherOptionEdit"),t),$("#otherOptionEdit .jqtransform").jqTransform()})}),n.listenTo(t.Events,"param:update",function(e){e.dismap==0?$("#map-switch").hide():$("#map-switch").show(),e.sms_on_off=="1"?$("#alarm_sms").removeClass("graylight").addClass("grelight"):$("#alarm_sms").removeClass("grelight").addClass("graylight"),e.email_on_off=="1"?$("#alarm_mail").removeClass("graylight").addClass("grelight"):$("#alarm_mail").removeClass("grelight").addClass("graylight"),e.voice_on_off=="1"?$("#alarm_sound").removeClass("graylight").addClass("grelight"):$("#alarm_sound").removeClass("grelight").addClass("graylight"),e.light_on_off=="1"?$("#alarm_light").removeClass("graylight").addClass("grelight"):$("#alarm_light").removeClass("grelight").addClass("graylight"),alert("修改成功")}),n.listenTo(t.Events,"monitoring:start",function(e){e.totals&&e.totals>0?$(".baojing").css("display","block"):$(".baojing").css("display","none"),$(".baojing .bg").html(e.totals||0)}),n.listenTo(t.Events,"monitoring:start:fail",function(e){e.totals&&e.totals>0?$(".baojing").css("display","block"):$(".baojing").css("display","none"),$(".baojing .bg").html(e.totals||0)}),n.listenTo(t.Events,"station:next",function(e){n.showBatteryEditDialog(!1,e)}),n.listenTo(t.Events,"battery:next",function(e){n.showUPSEditDialog(!1,e)})},switchUser:function(){e(["dialoglogin"],function(e){e&&e.show()})},about:function(){e(["dialogabout"],function(e){e.init(),e&&e.show()})},startCollectR:function(){var t=$("#cj_password").val();if(t!="bms"){alert("请输入正确的采集密码"),$("#cj_password").val("");return}e(["blocks/nav"],function(e){var t=e.getSites(),r;this.ids&&this.ids.sid?r=this.ids.sid:r=t.ids.join(",");if(r.split(",").length>1){alert("只能勾选一个站点");return}var i=e.getBatteryIds(),s=i?i.ids.join(","):"";$("#cj_password").val(""),$.ajax({url:"http://"+window.location.host+":3000"+"/irc",type:"post",data:{batterys:s}}),n.updateCollect({stationid:r,batterys:s},"rCollect:start")})},onSearch:function(){t.Events.trigger("search:done")},onExportCSV:function(){t.Events.trigger("export:done")},showItemsLayer:function(e){var n=$(e.currentTarget),s=n.offset(),o=/qurey/.test(window.location.href)?"qurey_"+n.attr("for"):n.attr("for"),u=i.cookie.getCookie(o+"Cols"),a=r.getListCols(o).concat([]),f=[],l="";u&&(u=u.split(","));if(!u||u.length==0)u=a;console.log(a,u),$.each(a,function(e,t){i.inArray(t.data,u)?t.ischeck="checked":t.ischeck="",l+=_.template('<label><input name="cols" type="checkbox" <%= ischeck %> key="<%= data %>"/><%= title %></label>')(t)}),$("<div class='config-item-list'>"+l+"</div>").dialog({dialogClass:"submenu",modal:!0,width:600,buttons:[{text:"全选",icons:{primary:"ui-icon-heart"},click:function(){$("[type=checkbox]",$(this)).each(function(e,t){$(t).attr("checked","checked")})}},{text:"确认",icons:{primary:"ui-icon-heart"},click:function(){var e="";$("[type=checkbox]:checked",$(this)).each(function(t,n){e+=$(n).attr("key")+","});if(!e){alert("请至少选择一列展示");return}i.cookie.setCookie(o+"Cols",e.replace(/,$/,"")),console.log("start trigger",o+"ColsChange"),t.Events.trigger(o+"ColsChange"),$(this).dialog("close")}}]}),$(".ui-dialog").css({top:s.top+n.height(),left:s.left+n.width()})},switchBtn:function(e){var t=$($(e.currentTarget).parents(".switch-btn")),n=t.siblings(".switch-btn");n.removeClass("active"),t.addClass("active")},showUnsolveDialog:function(t){e(["dialogresolveCaution"],function(e){e&&e.show(t)})},onSearchNav:function(){var e=$("#navSearchKeyword").val();n.getNavData(function(){},{key:e})},onUpadtaTime:function(){var e=parseInt($("#collectDuration").val());e&&n.updateParam({refresh:e},"refreshtime:update")},isCollecting:function(){return localStorage.getItem("collecting")==="true"},startCollect:function(){var e=parseInt($("#collectDuration").val()),t=window.location.hash,r=["#/manage/station","#/manage/group","#/manage/battery","#/manage/caution"];return e&&(r.indexOf(t)>-1?$("body").addClass("collecting").everyTime(e+"s","collect",n.collect):$("body").removeClass("collecting").stopTime("collect",n.collect),$("#startCollectBtn").hide(),$(".tzcj").css("display","block"),localStorage.setItem("collecting","true")),this},collectAuto:function(){this.isCollecting()?this.startCollect():this.stopCollect()},stopCollect:function(){return $("body").removeClass("collecting").stopTime("collect",n.collect),$("#startCollectBtn").css("display","block"),$(".tzcj").hide(),localStorage.setItem("collecting","false"),this},startGetCaution:function(){if(s)return;s=!0,$("body").everyTime("5s","monitoring",function(){n.getNavData(),n.getLinkingStationNum(),n.getCautionsData(!1,"monitoring:start",!0)})},stopGetCaution:function(){s=!1,$("body").stopTime("monitoring")},onAddStation:function(){this.showStationEditDialog()},showStationEditDialog:function(t){e(["dialogstationEdit"],function(e){e&&e.show(t)})},onAddBattery:function(){this.showBatteryEditDialog()},showBatteryEditDialog:function(t,n){e(["dialogbatteryEdit"],function(e){e&&e.show(t,n)})},onAddUPS:function(){this.showUPSEditDialog()},showUPSEditDialog:function(t,n){e(["dialogUPSEdit"],function(e){e&&e.show(t,n)})},onAddBMS:function(){this.showBMSEditDialog()},showBMSEditDialog:function(t){e(["dialogBMSEdit"],function(e){e&&e.show(t)})},onAddCompany:function(){this.showCompanyEditDialog()},showCompanyEditDialog:function(t){e(["dialogCompanyEdit"],function(e){e&&e.show(t)})},onAddMessage:function(){this.showMessageEditDialog()},showMessageEditDialog:function(t){e(["dialogmessageEdit"],function(e){e&&e.show(t)})},onAddPersonal:function(){this.showPersonalEditDialog()},showPersonalEditDialog:function(t){e(["dialogpersonalEdit"],function(e){e&&e.show(t)})},showLimitationEditDialog:function(t){e(["dialoglimitationEdit.js"],function(e){e.init(),e.show(t)})},onAddDevice:function(){this.showStationdeviceEditDialog()},showStationdeviceEditDialog:function(t){e(["dialogdeviceEdit.js"],function(e){e&&e.show(t)})},saveOtherOption:function(){e(["common"],function(e){var t=e.getFormValue($("#otherOptionEdit"));if(parseInt(t.refresh)<8){alert("刷新频率最小间隔8秒"),$("#otherOptionEdit [key=refresh]").val(8);return}if(parseInt(t.collection)<8){alert("采集频率最小间隔8秒"),$("#otherOptionEdit [key=collection]").val(8);return}t.dismap="0",t.sms_on_off="0",t.email_on_off="0",t.light_on_off="0",t.voice_on_off="0",$("#map-switch").hide(),$("#otherOptionEdit [key=dismap]").siblings(".jqTransformChecked").length&&(t.dismap="1",$("#map-switch").show()),$("#otherOptionEdit [key=sms_on_off]").siblings(".jqTransformChecked").length&&(t.sms_on_off="1"),$("#otherOptionEdit [key=light_on_off]").siblings(".jqTransformChecked").length&&(t.light_on_off="1"),$("#otherOptionEdit [key=voice_on_off]").siblings(".jqTransformChecked").length&&(t.voice_on_off="1"),$("#otherOptionEdit [key=email_on_off]").siblings(".jqTransformChecked").length&&(t.email_on_off="1"),n.updateParam(t)})},onAddStationOption:function(){this.showStationOptionEditDialog()},showStationOptionEditDialog:function(t){e(["dialogstationOptionEdit"],function(e){e&&e.show(t)})},showGroupOptionEditDialog:function(t){e(["dialoggroupOptionEdit"],function(e){e&&e.show(t)})},showBatteryOptionEditDialog:function(t){e(["dialogbatteryOptionEdit"],function(e){e&&e.show(t)})},showOhterOptionEditDialog:function(t){e(["dialogotherOptionEdit"],function(e){e&&e.show(t)})},resize:function(){u();var e=this,t=$(window).height(),n=$("div.top").outerHeight(),r=$("div.bottom").outerHeight();$("div.wrap").height(t-n-r);var i=$("div.wrap").height();$("div.down").height(i-i*.65-10);var s=$("div.status").is(":visible")?$("div.status").outerHeight():0,o=$("div.kscj").is(":visible")?$("div.kscj").outerHeight():0,a=$("div.cx").is(":visible")?$("div.cx").outerHeight():0,f=$("dl.set-list").is(":visible")?$("dl.set-list").outerHeight():0;return $("div.nav-tree").height(i-s-f-o-a-95),this},leftHide:function(){$("div.left").hide(),$("div.right").css("margin-left",0),$("b.yx-show").show(),$("div.down").is(":hidden")&&$("div.title-list span.zoom").addClass("big").attr("title","窗口还原")},leftShow:function(){$("div.left").show(),$("div.right").css("margin-left",$("div.left").outerWidth()),$("b.yx-show").hide(),$("span.zoom").hasClass("big")&&$("span.zoom").removeClass("big").attr("title","窗口最大化")},downHide:function(e){return $("div.down").hide(),!e||e.currentTarget?$("b.bottom-show").show():$("b.bottom-show").hide(),$("div.left").is(":hidden")&&$("div.title-list span.zoom").addClass("big").attr("title","窗口还原"),this.setH(),arguments[0].currentTarget&&t.Events.trigger("listdata:refresh"),this},downShow:function(e){if($("b.bottom-show").is(":visible")||e)$("div.down").show(),$("b.bottom-show").hide(),$("span.zoom").hasClass("big")&&$("span.zoom").removeClass("big").attr("title","窗口最大化"),this.setH();arguments[0].currentTarget&&t.Events.trigger("listdata:refresh")},upShow:function(e){var t=$(e.currentTarget);t.attr("class")=="zoom"?(t.addClass("big").attr("title","窗口还原"),this.leftHide(),$("#down").is(":visible")?this.downHide(e):this.downHide(e,!0),this.resizeAutoListWidth().resizePage()):(t.removeClass("big").attr("title","窗口最大化"),this.leftShow(e),this.downShow(e))},setH:function(){var e=$("div.up").height(),t=$("#subListTab").is(":visible")?$("#subListTab").height():0,n=$("#listBtns").is(":visible")?$("#listBtns").height():0,r=$(".list-bottom").is(":visible")?$(".list-bottom").height():0,i=$(".dataTable").is(":visible")?$(".dataTable").height():0,s=$(".tree-info-head").is(":visible")?$(".tree-info-head").height():0;$("div#yScrollBar").height(e-130-t-n-r-i),$("div.tree-info-body").height(e-100-t-n-s-30)},resizeAutoListWidth:function(){return $("#auto").width($("#list").width()-$("#lock").width()),this},resizePage:function(){return $("#xScrollBar").width($("#list").width()-$("#page").width()),this},switchNav:function(e,t,n){return e&&($(".nav-list .switch-btn").removeClass("active"),$(".nav-list ."+e).addClass("active")),t&&($(".item-list .switch-btn").removeClass("active"),$(".item-list ."+t).addClass("active")),n&&($(".sub-list-tab .switch-btn").removeClass("active"),$(".sub-list-tab ."+n).addClass("active")),this},switchChartBtns:function(e){return e&&($(".btn-wrap .btns").hide(),$(".btn-wrap .btns."+e).show()),this},switchBtnGroups:function(e,t,n){var r=$("#listBtns ."+t+(n?"-"+n:"")),i=$("#subListTab ."+t);return $(".item-list .switch-btn").hide(),$(".item-list ."+e).show(),i.length?($(".sub-list-tab").show(),$(".sub-list-tab .switch-btn").hide(),$(".sub-list-tab ."+t).show()):$(".sub-list-tab").hide(),r.length?($("#listBtns").show(),$("#listBtns li").hide(),r.show()):$("#listBtns").hide(),this},switchListAlertBox:function(e){return $(".show-list dd").show(),this},resizeChartBox:function(){return this},getListWidth:function(){return $("#list").width()},getListHeight:function(){var e=$("div.up").height(),t=$(".list-header").height()+10,n=$(".right-header").height(),r=$("#page").height();return 500}}),a=new o;return a.startGetCaution(),$(window).resize(function(){u(),a.resize(),a.resizeAutoListWidth().resizePage().resizeChartBox()}),a});