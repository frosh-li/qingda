define(["require","backbone","api","stationsinfoDialog","common"],function(e,t,n,r,i){var s={w:27,h:38,icon:{0:"images/1.png",1:"images/2.png",2:"images/3.png",3:"images/4.png"},label:{normal:{color:"#000000",fontWeight:"bold",fontSize:"14px",backgroundColor:"#fff5cd",border:"1px solid #ffcc69"},caution:{color:"#000000",fontWeight:"bold",fontSize:"14px",backgroundColor:"#ffd9d9",border:"1px solid #be1616"},notice:{color:"#000000",fontWeight:"bold",fontSize:"14px",backgroundColor:"#ffd9d9",border:"1px solid #be1616"}}},o={x:104.603639,y:35.140578,zoom:5},u=t.View.extend({options:{},initialize:function(e){var n=this;$.extend(n.options,e||{}),n.listenTo(t.Events,"realtime:mapdata",function(e){n.data=e.list,n.addMarks(),n.buildCityList()}),n.listenTo(t.Events,"mapdata:update",function(e){n.data=e.list,n.addMarks(),n.buildCityList(),n.centerAndZoom({x:o.x,y:o.y,zoom:o.zoom})}),n.listenTo(t.Events,"mapdata:update:fail",function(e){n.centerAndZoom({x:o.x,y:o.y,zoom:o.zoom}),$(".mapbtn").html("<select><option>全国</option></select>")}),n.listenTo(t.Events,"linknum:get",function(e){$("#linkingNum").html(e.online),$("#unlinkNum").html(e.offline)}),n._initBDMapCallBack(),n._loadBDMap()},render:function(){var e=this,t=e.options;this.map=new BMap.Map("map"),this.map.enableScrollWheelZoom(!0),t.cityList&&e.addCityList()},unload:function(){this.map=null},addMarks:function(){var e=this,t=e.data,n=e.map,i=0;t&&t.length&&$.each(t,function(t,o){var u=new BMap.Point(o.site_longitude,o.site_latitude),a=new BMap.Icon(s.icon[o.status||"0"],new BMap.Size(s.w,s.h)),f=new BMap.Marker(u,{icon:a}),l=o.site_name.replace(/[^\x00-\xff]/g,"aa").length.toString(),c=new BMap.Label(o.site_name,{offset:new BMap.Size(-(l*6)/2+8,40)});c.setStyle(s.label[o.status||"0"]),parseInt(o.status||"0")>0&&i++,f.addEventListener("click",function(e){return function(){r.show(e.serial_number)}}(o)),c.addEventListener("click",function(e){return function(){r.show(e.serial_number)}}(o)),f.setLabel(c),e.map.addOverlay(f),n[o.id]=$.extend(!0,o,{icon:a,marker:f})}),$(".baojing .bg").html(i)},centerAndZoom:function(e){var t=new BMap.Point(e.x,e.y);this.map.centerAndZoom(t,e.zoom)},buildCityList:function(){var e=this,t=this.data,n=new BMap.Geocoder,r=[],s="<select><option>全国</option>",u=0,a=t.length;$.each(t,function(t,f){var l=new BMap.Point(f.site_longitude,f.site_latitude);n.getLocation(l,function(t){var f=t.addressComponents;if(!i.inArray(f.city,r)){r.push(f.city);var l=localStorage.getItem("currentCity")||"全国";l==f.city?s+="<option selected>"+f.city+"</option>":s+="<option>"+f.city+"</option>"}u++,u==a&&(s+="</select>",$(".mapbtn").html(s),$(".mapbtn select").off("change").on("change",function(){var t=$(".mapbtn select option:selected").html();localStorage.setItem("currentCity",t),"全国"==t?e.centerAndZoom({x:o.x,y:o.y,zoom:o.zoom}):n.getPoint(t,function(t){t?e.map.centerAndZoom(t,12):alert("您选择地址没有解析到结果!")})}))})})},to:function(e){this.map.panTo(new BMap.Point(e.x,e.y))},addCityList:function(){var e=new BMap.Size(10,20),t=this;this.map.addControl(new BMap.CityListControl({anchor:BMAP_ANCHOR_TOP_LEFT,offset:e,onChangeBefore:function(){},onChangeAfter:function(){console.log("after select city"),t.addMarks()}}))},_loadBDMap:function(){var e=document.createElement("script");e.type="text/javascript",e.src="http://api.map.baidu.com/api?v=2.0&ak=1b010415afbe080fcca3807108847acc&callback=MapCallback",document.body.appendChild(e)},_initBDMapCallBack:function(){var e=this;window.MapCallback=function(){e.render(),n.getMapData()}}}),a=null;return{init:function(e){return a&&(delete a,a=null),a=new u,r.init(),n.getLinkingStationNum(),this}}});