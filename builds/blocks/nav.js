window.NavDatas=null,define(["require","api","backbone","context","common","zTreeExcheck"],function(e,t,n,r,i){var s,o=!1,u={check:{enable:!0},data:{key:{name:"title"},simpleData:{enable:!0,pIdKey:"pid"}},callback:{onCheck:function(){o=!1,r.setCurStations(a.getCheckedData())}}},a,f={el:$("#nav"),name:"nav",data:null,tree:null,navPlugin:null,initialize:function(e){var t=this;t.listenTo(n.Events,"nav:update",function(e){if(NavDatas==JSON.stringify(e))return;NavDatas=JSON.stringify(e),console.log("nav update",e),t.data=e.list,t.filterData().render(),o=!0})},filterData:function(){return this},getCheckedData:function(){var e=this.tree.getCheckedNodes(),t={};return $.each(e,function(e,n){t[n.id]={id:n.id,pId:n.pId,name:n.name,level:n.level}}),t},expandNode:function(){var e=this.tree,t=e.transformToArray(e.getNodes());for(var n=0;n<t.length;n++){var r=t[n];r.leveltype==3?e.expandNode(r,!1):e.expandNode(r,!0)}},render:function(){console.log("render tree now",this.ids),$.fn.zTree.init($("#nav"),u,this.data),this.tree=$.fn.zTree.getZTreeObj("nav"),this.expandNode();var e=this,t=window.location.hash;/^#\/manage\/station\/[0-9]+$/.test(t)&&(this.ids={sid:t.match(/([0-9]+)/)[1]});if(this.ids){if(this.ids.sid){var n=this.tree.getNodes();for(var r=0,i=n.length;r<i;r++)if(n[r].leveltype===1){var s=n[r].children;for(var o=0;o<s.length;o++){var a=s[o].children;if(!a)continue;for(var f=0;f<a.length;f++)a[f].children.forEach(function(t){t.leveltype===2&&t.id===e.ids.sid&&e.tree.checkNode(t,!0,!0)})}}}}else this.tree.checkAllNodes(!0);return this}};return{init:function(e,t,r,i){return a||(a=new(n.View.extend($.extend(!0,{},f,{ids:i})))),this},run:function(e){t.getNavData(e)},isOver:function(e){if(typeof e=="undefined")return!!o;o=!!e},getSites:function(){var e={ids:[],map:{},pids:[]},t;if(a.tree){var t=a.tree.getCheckedNodes();$.each(t,function(t,n){n.leveltype=="2"&&(e.ids.push(n.id),e.pids.push(n.pid),e.map[n.id]=n)})}return e},getSelectedNodePid:function(){var e=[];if(a.tree){var t=a.tree.getSelectedNodes();$.each(t,function(t,n){e.push(n.pid)})}return e},getSelectedNodeId:function(){var e=-1;if(a.tree){var t=a.tree.getSelectedNodes();$.each(t,function(t,n){e=n.id})}return e},getGroups:function(){var e={ids:[],map:{}},t;return a.tree&&(t=a.tree.getCheckedNodes(),$.each(t,function(t,n){n.leveltype=="3"&&(e.ids.push(n.id),e.map[n.id]=n)})),e},getBatterys:function(e){var t={ids:[],map:{}},n,r=[],s;return e&&(n=this.getGroups(),$.each(n.ids,function(t,i){n.map[i].pid==e&&r.push(i)})),e&&!r.length?!1:(a.tree&&(s=a.tree.getCheckedNodes(),$.each(s,function(n,s){if(s.leveltype=="4"){if(r&&r.length&&!i.inArray(s.pid,r))return;s.id.substring(0,10)==e&&(t.ids.push(s.id),t.map[s.id]=s)}})),console.log("getBatterys",t,e),t)},getBatteryIds:function(){var e={ids:[],map:{}},t;return a.tree&&(t=a.tree.getCheckedNodes(),$.each(t,function(t,n){n.leveltype=="4"&&(e.ids.push(n.id),e.map[n.id]=n)})),e}}});