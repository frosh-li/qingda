define(["require","api","context","ui"],function(e,t,n,r){function u(e,t,n){var r="",i=e?t[e].sids:[],n=parseInt(n);if(i&&i.length){var s=i.length;return $.each(i,function(e,o){i.length>1&&e!=s-1&&(t[o].hasSameLevelClass="same-level"),r+=u(o,t,n+1)}),_.template($("#treeInfoItemTpl").html())($.extend(t[e],{subhtml:r,level:n}))}return e&&t[e]?_.template($("#treeInfoItemTpl").html())($.extend({},t[e],{subhtml:"",level:n})):(data=e&&t?t[e]:{},_.template($("#treeInfoItemTpl").html())($.extend(data,{id:"",pid:"",title:"",level:n,hasSameLevelClass:"",subhtml:"",ifhide:""})))}var i=null,s=!1,o=Backbone.View.extend({el:"#dataItem",events:{"blur .level-title-input":"onBlur","click .delete-level":"onDel","click .add-level":"onAddSub","click .add-same-level":"onAddSame"},initialize:function(){var e=this;e.listenTo(Backbone.Events,"tree:get:fail",function(t){"-1"==t.response.code&&(e.data=[],e.render(),s=!0)}),e.listenTo(Backbone.Events,"tree:get",function(t){e.data=t,e.render(),s=!0}),e.listenTo(Backbone.Events,"tree:create",function(e){alert("添加成功"),t.getTreeInfo(),t.getNavData()}),e.listenTo(Backbone.Events,"tree:update",function(e){alert("修改成功"),t.getTreeInfo(),t.getNavData()}),e.listenTo(Backbone.Events,"tree:delete",function(e){alert("删除成功"),t.getTreeInfo(),t.getNavData()})},onAddSub:function(e){var t=this,n=$(e.target),r=t.getItemData(n),i=n.parents(".tree-item-wrap").children(".tree-info-subitem-sub").eq(0),s=n.parents(".tree-item-wrap").eq(0),o=s.parent(".tree-info-subitem-sub").children(".tree-item-wrap"),a=u(!1,!1,parseInt(s.attr("level"))+1);i.append(a),i.children(".tree-info-subitem").eq(0).addClass("same-level"),o.length>1?(o.addClass("same-level"),o.last().removeClass("same-level")):o.removeClass("same-level")},onAddSame:function(e){var t=this,n=$(e.target),r=t.getItemData(n),i=n.parents(".tree-item-wrap").eq(0),s=u(!1,!1,r.level);$(s).insertAfter(i),i.addClass("same-level")},scrollToRightBottom:function(){$(".tree-info-body").scrollTop($(".tree-info-body").height()),$(".tree-info-body").scrollLeft($(".tree-info-body").width())},onDel:function(e){var n=this,r=$(e.target),i=r.siblings(".level-name").val(),s=r.parents(".tree-item-wrap").eq(0),o=n.getItemData(r);confirm("是否确认删除此节点")&&(o&&o.id?t.deleteTree(o):s.remove())},onBlur:function(e){var n=this,r=$(e.target),i=r.val(),s=r.attr("current-title"),o;if(i==s)return;o=n.getItemData(r);if(o){o.title=i;if(o.id){if(!o.title||!o.title.length){alert("标题不可直接清空");return}t.updateTree(o)}else t.createTree({title:i,pid:r.parents(".tree-item-wrap[treeid!='']").attr("treeid")})}},getItemData:function(e){if(e&&e.length){var t=e.parents(".tree-item-wrap");return{id:t.attr("treeid"),pid:t.attr("pid"),level:t.attr("level")}}return!1},filterData:function(e){var t=null,n=null,r=[];return $.each(e,function(e,r){if(!r.pid||"0"==r.pid)n=r;else{t=t||{},t[r.id]=r,r.subhtml="",r.hasSameLevelClass="",r.level="";var i=JSON.parse(localStorage.getItem("userinfo")).role;i!=1?r.ifhide="hide":r.ifhide="",t[r.id].html=_.template($("#treeInfoItemTpl").html())(r)}}),t&&$.each(t,function(e,i){i.pid&&(n.id==i.pid?r.push(e):t[i.pid]?t[i.pid].sids?t[i.pid].sids.push(e):t[i.pid].sids=[e]:alert("数据解析失败"))}),{root:n,sub:t,first:r}},render:function(){var e=this,t=e.data,n=t.num||5;if(t.list&&t.list.length){var i=e.filterData(t.list);i.root?$("#dataItem").html(_.template($("#treeInfoTpl").html())(i.root)):alert("缺少顶级层数据");if(i.first.length){var s="";$.each(i.first,function(e,t){i.first.length>1&&e!=i.first.length-1&&(i.sub[t].hasSameLevelClass="same-level"),s+=u(t,i.sub,1)})}else s=u();$(".tree-info-subwrap").html(s)}else $(".tree-info-subwrap").html($("#treeInfoItemTpl").html());r.setH()},destory:function(){console.log("detroy tree"),this.stopListening()}});return{init:function(e,n,r){i=new o,t.getTreeInfo()},isOver:function(e){if(typeof e=="undefined")return!!s;s=!!e},destory:function(){i.destory()}}});